name: Build and Deploy Production

on:
  push:
    branches: [main, beta]
  pull_request:
    branches: [main, beta]

env:
  NODE_VERSION: '20'
  RUST_VERSION: 'stable'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run comprehensive test suite
        run: |
          npm run test -- --run --coverage
          npm run test:unit -- --run
        env:
          CI: true
          
      - name: ğŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  build-wasm:
    name: Build WebAssembly Financial Engine
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ¦€ Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          target: wasm32-unknown-unknown
          override: true
          components: rustfmt, clippy
          
      - name: ğŸ“¦ Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
        
      - name: ğŸ—‚ï¸ Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            wasm-financial-engine/target
          key: rust-${{ hashFiles('wasm-financial-engine/Cargo.lock') }}
          restore-keys: |
            rust-
            
      - name: ğŸ”§ Build WASM financial engine
        run: |
          cd wasm-financial-engine
          wasm-pack build --target web --out-dir pkg --release
          ls -la pkg/
          
      - name: ğŸ“¤ Upload WASM artifacts
        uses: actions/upload-artifact@v3
        with:
          name: wasm-financial-engine
          path: wasm-financial-engine/pkg/
          retention-days: 5

  build-frontend:
    name: Build Frontend Application
    runs-on: ubuntu-latest
    needs: [test, build-wasm]
    
    steps:
      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ“¥ Download WASM artifacts
        uses: actions/download-artifact@v3
        with:
          name: wasm-financial-engine
          path: wasm-financial-engine/pkg/
          
      - name: ğŸ—‚ï¸ Cache Vite build
        uses: actions/cache@v3
        with:
          path: |
            node_modules/.vite
            node_modules/.cache
          key: vite-${{ hashFiles('package-lock.json') }}-${{ hashFiles('src/**/*') }}
          restore-keys: |
            vite-${{ hashFiles('package-lock.json') }}-
            vite-
            
      - name: ğŸ”¨ Build production application
        run: |
          npm run build
          ls -la dist/
        env:
          NODE_ENV: production
          VITE_APP_VERSION: ${{ github.sha }}
          VITE_BUILD_TIME: ${{ github.event.head_commit.timestamp }}
          
      - name: ğŸ“Š Analyze bundle size
        run: |
          npx bundlesize
          du -sh dist/assets/*
          
      - name: ğŸ§¹ Cleanup artifacts
        run: |
          # Remove source maps from production if not needed
          find dist -name "*.map" -type f -delete || true
          
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: production-build
          path: dist/
          retention-days: 30

  deploy-staging:
    name: Deploy to Staging (Beta)
    runs-on: ubuntu-latest
    needs: [build-frontend]
    if: github.ref == 'refs/heads/beta'
    environment: staging
    
    steps:
      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: production-build
          path: dist/
          
      - name: ğŸš€ Deploy to Vercel (Beta)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-frontend]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: production-build
          path: dist/
          
      - name: ğŸš€ Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
          
      - name: ğŸ“Š Performance audit
        run: |
          echo "ğŸ¯ Production deployment completed successfully!"
          echo "ğŸ“Š Build metrics:"
          echo "- Version: ${{ github.sha }}"
          echo "- Environment: production"
          echo "- Build time: $(date)"

  security-scan:
    name: Security & Vulnerability Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ” Run security audit
        run: |
          npm audit --audit-level=moderate
          npx better-npm-audit audit
        continue-on-error: true
        
      - name: ğŸ” Dependency vulnerability check
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true

  notification:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: ğŸ“£ Notify deployment status
        run: |
          if [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "âœ… Production deployment successful!"
          elif [[ "${{ needs.deploy-staging.result }}" == "success" ]]; then
            echo "âœ… Staging deployment successful!"
          else
            echo "âŒ Deployment failed or skipped"
          fi