# On Tour App - v2.2 Roadmap

**Version:** 2.2.0-beta  
**Target Release:** Q1 2026 (January - March)  
**Current Version:** 2.1.0-beta  
**Status:** üìã Planning Phase

---

## üéØ Vision & Goals

**Primary Objective:** Transform On Tour from a solid multi-tenant platform into a **production-ready, enterprise-grade touring management system** with enhanced security, performance, and user experience.

**Success Metrics:**
- ‚úÖ Test coverage: 73.5% ‚Üí **85%**
- ‚úÖ i18n completeness: EN/ES 100%, FR/DE/IT/PT 35-43% ‚Üí **100% all languages**
- ‚úÖ Security: Remove all High-severity vulnerabilities
- ‚úÖ Performance: Bundle size 845KB ‚Üí **<700KB**, Load time 1.8s ‚Üí **<1.5s**
- ‚úÖ User satisfaction: NPS score increase from baseline (beta users)
- ‚úÖ Production readiness: All critical features audited and hardened

---

## üìä Priority Matrix

### Priority 1: Security & Compliance (Critical)
**Timeline:** Weeks 1-4  
**Impact:** High | **Risk if delayed:** Critical

### Priority 2: Performance & Testing (High)
**Timeline:** Weeks 3-8  
**Impact:** High | **Risk if delayed:** Medium

### Priority 3: Feature Enhancements (Medium)
**Timeline:** Weeks 5-10  
**Impact:** Medium | **Risk if delayed:** Low

### Priority 4: User Experience (Medium)
**Timeline:** Weeks 8-12  
**Impact:** High | **Risk if delayed:** Low

---

## üîí Priority 1: Security & Compliance

### 1.1 Remove xlsx Vulnerability (Week 1-2)

**Current Issue:**
- `xlsx` (SheetJS) has High-severity Prototype Pollution and ReDoS vulnerabilities
- Status: Acknowledged but not fixed
- Risk: Low (export-only, no user uploads) but exists

**Solution:**
- **Replace xlsx with safer alternatives:**
  - **Option A:** `exceljs` - Pure JS, actively maintained, no known vulnerabilities
  - **Option B:** `PapaParse` for CSV + lighter Excel lib for .xlsx
  - **Recommendation:** Use both - `PapaParse` for CSV (lighter), `exceljs` for Excel

**Implementation:**
```typescript
// src/lib/exportToExcel.ts - Refactor
import ExcelJS from 'exceljs';

export async function exportToExcel(data: any[], filename: string) {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('Data');
  
  // Add headers, styling, data
  // ...
  
  const buffer = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buffer], { 
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
  });
  saveAs(blob, `${filename}.xlsx`);
}
```

**Tasks:**
- [ ] Install `exceljs` and `papaparse`
- [ ] Refactor `src/lib/exportToExcel.ts`
- [ ] Add CSV export option (faster, lighter)
- [ ] Update tests for new export functions
- [ ] Remove `xlsx` dependency
- [ ] Run `npm audit` - verify no High vulnerabilities
- [ ] Update SECURITY.md - remove acknowledged vulnerability

**Testing:**
- [ ] Export shows (100+ records) to Excel
- [ ] Export finance data with formulas
- [ ] Export contacts with special characters
- [ ] Verify file opens in Excel, Google Sheets, LibreOffice
- [ ] Performance test: 10,000 rows export time

**Success Criteria:**
- ‚úÖ No High/Critical npm audit vulnerabilities
- ‚úÖ Excel exports work identically to before
- ‚úÖ CSV export option available (faster)
- ‚úÖ Export performance improved by 20%+

---

### 1.2 Complete Audit Logging (Week 2-3)

**Current State:**
- Timeline shows basic activities (create, update, delete)
- No detailed change tracking (old value ‚Üí new value)
- No filtering by field changed

**Enhancement:**
```typescript
// src/types/activity.ts - Enhanced Activity
export interface DetailedActivity extends Activity {
  changes?: {
    field: string;
    oldValue: any;
    newValue: any;
    userId: string;
    userEmail: string;
  }[];
  ipAddress?: string; // For security audits
  userAgent?: string;
  sessionId?: string;
}
```

**Implementation:**
- [ ] Create `AuditService` for granular logging
- [ ] Track field-level changes (e.g., "Fee: ‚Ç¨2000 ‚Üí ‚Ç¨2500")
- [ ] Log IP address and user agent (GDPR-compliant)
- [ ] Add export audit logs to CSV/Excel
- [ ] Integrate with Sentry for critical changes (permissions, deletions)

**Use Cases:**
- **Accounting:** "Who changed the fee for Paris show?"
- **Security:** "When was this user's role changed to Admin?"
- **Compliance:** Export audit logs for tax authorities

**Success Criteria:**
- ‚úÖ All financial changes logged with old/new values
- ‚úÖ Permission changes logged with timestamps
- ‚úÖ Audit logs exportable to CSV
- ‚úÖ Retention policy: 2 years (configurable)

---

### 1.3 Mandatory MFA & Hardware Key Support (Week 3-4)

**Current State:**
- MFA optional for all roles
- Supports SMS, TOTP, Email
- No hardware key support

**Enhancement:**
```typescript
// Org settings - MFA policy
export interface MFAPolicy {
  enabled: boolean;
  requiredForRoles: OrgRole[]; // ['owner', 'admin']
  allowedMethods: ('sms' | 'totp' | 'email' | 'webauthn')[];
  gracePeriodDays: number; // 7 days to enable after joining
}
```

**Implementation:**
- [ ] Add WebAuthn support (YubiKey, Touch ID, Face ID)
- [ ] Org-level MFA policy settings
- [ ] Enforce MFA for Owner/Admin roles (optional for Members/Viewers)
- [ ] Grace period: 7 days to set up after joining
- [ ] MFA recovery flow with backup codes
- [ ] Biometric authentication for mobile PWA

**Tasks:**
- [ ] Install `@simplewebauthn/browser` and `@simplewebauthn/server`
- [ ] Add WebAuthn setup in Settings ‚Üí Security
- [ ] Create MFA policy UI in Organization settings
- [ ] Email notifications: "MFA required in 3 days"
- [ ] Block access after grace period expires
- [ ] Add "MFA Status" column in Members table

**Success Criteria:**
- ‚úÖ Hardware keys (YubiKey, etc.) supported
- ‚úÖ Biometric auth works on mobile (Touch ID, Face ID)
- ‚úÖ Org admins can enforce MFA policy
- ‚úÖ 90%+ adoption rate in beta organizations

---

## üöÄ Priority 2: Performance & Testing

### 2.1 Achieve 85% Test Coverage (Week 3-6)

**Current Coverage:** 73.5%  
**Target:** 85%  
**Gap:** 11.5% (‚âà100 additional tests)

**Coverage Breakdown (Current):**
```
Statements   : 73.5%
Branches     : 68.2%
Functions    : 71.8%
Lines        : 73.9%
```

**Focus Areas:**

#### 2.1.1 Multi-Tenancy Isolation Tests
**Critical:** Ensure data doesn't leak between orgs

```typescript
// src/__tests__/multi-tenancy/data-isolation.test.ts
describe('Multi-Tenancy Data Isolation', () => {
  it('should not show org A shows to org B user', async () => {
    // Create 2 orgs, add shows to each
    // Switch user to org B
    // Verify only org B shows visible
  });
  
  it('should prevent cross-org data modification', async () => {
    // Attempt to edit org A show while in org B
    // Expect permission denied
  });
});
```

**Tests needed:**
- [ ] 15 tests: Data isolation (shows, contacts, contracts, finance)
- [ ] 10 tests: Permission enforcement (RBAC)
- [ ] 8 tests: Org switching and context management

#### 2.1.2 Offline Sync & Conflict Resolution Tests

```typescript
// src/__tests__/offline/conflict-resolution.test.ts
describe('Offline Conflict Resolution', () => {
  it('should merge non-conflicting changes', async () => {
    // Edit show offline (change city)
    // Teammate edits same show online (change fee)
    // Go online, trigger sync
    // Expect both changes merged
  });
  
  it('should prompt user on conflicting changes', async () => {
    // Edit show offline (change fee to ‚Ç¨2000)
    // Teammate edits same show online (change fee to ‚Ç¨2500)
    // Go online, trigger sync
    // Expect conflict dialog with options
  });
});
```

**Tests needed:**
- [ ] 12 tests: Offline create, update, delete
- [ ] 8 tests: Conflict detection and resolution
- [ ] 5 tests: Background sync and retry logic

#### 2.1.3 E2E Critical Flows (Playwright)

```typescript
// e2e/critical-flows/multi-org-tour-management.spec.ts
test('Full tour management flow with team', async ({ page }) => {
  // 1. Owner creates org
  // 2. Invites admin and member
  // 3. Admin creates 10 shows
  // 4. Member adds venue details
  // 5. Owner exports financial report
  // 6. Admin changes member to viewer
  // 7. Verify viewer cannot edit
});
```

**Tests needed:**
- [ ] 10 E2E tests: Critical user flows
- [ ] 8 E2E tests: Mobile PWA functionality
- [ ] 5 E2E tests: Real-time sync between users

**Testing Strategy:**
1. **Week 3-4:** Write unit tests (multi-tenancy, offline)
2. **Week 5:** Write integration tests (API, Firestore)
3. **Week 6:** Write E2E tests (Playwright)
4. **Week 6:** Run coverage report, fix gaps

**Success Criteria:**
- ‚úÖ 85%+ coverage on Statements, Branches, Functions, Lines
- ‚úÖ All critical paths have E2E tests
- ‚úÖ CI/CD blocks merges below 80% coverage

---

### 2.2 Bundle Size & Performance Optimization (Week 4-7)

**Current:**
- Bundle size: ~845KB (gzipped)
- Load time: 1.8s (good connection)
- Target: <700KB, <1.5s

**Optimization Strategy:**

#### 2.2.1 Code Splitting for Heavy Routes

```typescript
// src/routes/AppRouter.tsx - Aggressive splitting
const FinanceReports = lazy(() => import('@/pages/dashboard/FinanceReports'));
const ExportPage = lazy(() => import('@/pages/dashboard/Export'));
const AdvancedSettings = lazy(() => import('@/pages/settings/Advanced'));

// Only load when user navigates to these routes
```

**Routes to split:**
- [ ] Finance Reports (charts heavy)
- [ ] Export page (Excel/PDF libs)
- [ ] Advanced settings (rarely used)
- [ ] Contract viewer (PDF.js)
- [ ] Map/Travel planning (MapLibre)

**Expected savings:** 150-200KB

#### 2.2.2 Library Replacements

```typescript
// Before: date-fns (full bundle)
import { format, parseISO, addDays } from 'date-fns';

// After: Intl API (built-in, 0KB)
const format = (date: Date, pattern: string) => {
  return new Intl.DateTimeFormat('es-ES', {
    dateStyle: 'medium',
    timeStyle: 'short'
  }).format(date);
};
```

**Replacements:**
- [ ] Replace `date-fns` with Intl API where possible (save ~15KB)
- [ ] Replace `lodash` with native methods (save ~10KB)
- [ ] Lazy load `chart.js` (only load when charts visible)
- [ ] Use dynamic imports for i18n languages (load on demand)

**Expected savings:** 40-60KB

#### 2.2.3 Mobile PWA Optimizations

```typescript
// src/lib/performance.ts - Mobile optimizations
export const isMobile = () => window.innerWidth < 768;

export function reducedMotion() {
  return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
}

// Disable animations on low-end devices
if (isMobile() && navigator.hardwareConcurrency <= 4) {
  document.body.classList.add('reduce-animations');
}
```

**Optimizations:**
- [ ] Detect low-end devices, reduce animations
- [ ] Use `IntersectionObserver` to lazy load images
- [ ] Reduce Framer Motion usage (already analyzed, continue)
- [ ] Test on actual Android devices (Samsung Galaxy A series)
- [ ] Add performance budgets in Lighthouse CI

**Testing:**
- [ ] Lighthouse on mobile (target: 90+ Performance score)
- [ ] Test on 3G connection (target: <3s load)
- [ ] Test on old Android (Android 9, 2GB RAM)

**Success Criteria:**
- ‚úÖ Bundle size < 700KB (gzipped)
- ‚úÖ First Contentful Paint < 1s
- ‚úÖ Time to Interactive < 1.5s
- ‚úÖ Lighthouse Performance score: 90+

---

### 2.3 Offline Conflict Resolution (Week 6-8)

**Current State:**
- Offline mode works (IndexedDB + Background Sync)
- Conflicts are detected but not auto-resolved
- User sees error, must manually fix

**Enhanced Conflict Resolution:**

```typescript
// src/services/ConflictResolver.ts
export class ConflictResolver {
  /**
   * Auto-resolve non-conflicting changes
   * Example: User A changes city, User B changes fee
   * Result: Merge both changes
   */
  static autoMerge(local: Show, remote: Show): Show {
    const merged = { ...remote }; // Start with remote (latest)
    
    // Merge non-conflicting fields
    Object.keys(local).forEach(key => {
      if (local[key] !== remote[key] && this.isNonConflicting(key)) {
        merged[key] = local[key]; // Prefer local change
      }
    });
    
    return merged;
  }
  
  /**
   * Detect true conflicts (same field changed by both)
   */
  static detectConflicts(local: Show, remote: Show): Conflict[] {
    const conflicts: Conflict[] = [];
    
    Object.keys(local).forEach(key => {
      if (local[key] !== remote[key] && !this.isNonConflicting(key)) {
        conflicts.push({
          field: key,
          localValue: local[key],
          remoteValue: remote[key],
          timestamp: new Date(),
        });
      }
    });
    
    return conflicts;
  }
}
```

**Conflict Resolution UI:**
```tsx
// src/components/ConflictDialog.tsx
export function ConflictDialog({ conflicts, onResolve }) {
  return (
    <Dialog>
      <DialogTitle>Conflictos Detectados</DialogTitle>
      <DialogContent>
        <p>T√∫ y {conflicts[0].user} editasteis el mismo show offline.</p>
        
        {conflicts.map(conflict => (
          <div key={conflict.field}>
            <h4>{conflict.field}</h4>
            <RadioGroup>
              <Radio value="local">
                Tu cambio: {conflict.localValue}
              </Radio>
              <Radio value="remote">
                Cambio de {conflict.user}: {conflict.remoteValue}
              </Radio>
              <Radio value="merge">
                Combinar: {/* Smart merge if possible */}
              </Radio>
            </RadioGroup>
          </div>
        ))}
      </DialogContent>
      <DialogActions>
        <Button onClick={() => onResolve('local')}>Usar mis cambios</Button>
        <Button onClick={() => onResolve('remote')}>Usar cambios remotos</Button>
      </DialogActions>
    </Dialog>
  );
}
```

**Implementation:**
- [ ] Create `ConflictResolver` service
- [ ] Implement auto-merge for non-conflicting changes
- [ ] Create ConflictDialog UI component
- [ ] Add "Last synced" indicator in UI
- [ ] Show merge preview before applying
- [ ] Track conflict resolution in Timeline

**Use Cases:**
- **Scenario 1:** Tour manager edits show city offline, agent edits fee online ‚Üí Auto-merge
- **Scenario 2:** Both edit same field (fee) ‚Üí Show dialog, user chooses
- **Scenario 3:** Manager deletes show offline, agent edits it online ‚Üí Show dialog

**Success Criteria:**
- ‚úÖ 80%+ conflicts auto-resolved (non-conflicting fields)
- ‚úÖ Conflict dialog clear and intuitive
- ‚úÖ Zero data loss in conflict scenarios
- ‚úÖ Conflicts logged in Timeline

---

## üé® Priority 3: Feature Enhancements

### 3.1 Venue Management & Logistics (Week 5-8)

**Current State:**
- Venues stored as contacts (basic info)
- No map-based venue discovery
- Manual distance/travel cost calculation

**Enhanced Venue System:**

#### 3.1.1 Interactive Venue Map

```tsx
// src/pages/dashboard/VenueMap.tsx
import maplibregl from 'maplibre-gl';
import { useVenues } from '@/hooks/useVenues';

export function VenueMap() {
  const { venues } = useVenues();
  
  // Show all venues on map
  // Cluster nearby venues
  // Click venue ‚Üí show details + book show
  // Search radius: "Show venues within 100km of Paris"
}
```

**Features:**
- [ ] Map view of all venues (already have MapLibre)
- [ ] Cluster markers for nearby venues
- [ ] Click venue ‚Üí Quick show creation
- [ ] Search by distance: "Venues within 100km of Paris"
- [ ] Filter by capacity, type, availability

#### 3.1.2 Venue Scouting & Auto-Fill

```typescript
// src/services/VenueService.ts - Google Places integration
export class VenueService {
  static async searchVenues(query: string, location: LatLng) {
    // Use Google Places API
    const response = await fetch(
      `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${query}&location=${location.lat},${location.lng}&radius=50000&type=music_venue`
    );
    
    return response.json();
  }
  
  static async autofillVenueDetails(placeId: string) {
    // Fetch full venue details
    const details = await getPlaceDetails(placeId);
    
    return {
      name: details.name,
      address: details.formatted_address,
      phone: details.formatted_phone_number,
      website: details.website,
      coordinates: details.geometry.location,
      capacity: this.estimateCapacity(details), // From reviews/types
      photos: details.photos,
    };
  }
}
```

**Implementation:**
- [ ] Integrate Google Places API (or OpenStreetMap + Nominatim)
- [ ] Venue search with autocomplete
- [ ] Auto-fill venue details from Places
- [ ] Upload venue photos
- [ ] Venue reviews/notes from team

#### 3.1.3 Travel Distance & Cost Calculator

```typescript
// src/lib/travelCalculator.ts
export function calculateTravelCosts(
  fromVenue: Venue,
  toVenue: Venue,
  options: TravelOptions
) {
  const distance = getDistance(fromVenue.coordinates, toVenue.coordinates);
  
  // Calculate costs based on travel mode
  switch (options.mode) {
    case 'car':
      return {
        distance,
        duration: distance / 80, // km/h average
        cost: distance * 0.15, // ‚Ç¨0.15/km fuel + tolls
        emissions: distance * 0.12, // kg CO2
      };
    case 'flight':
      return {
        distance,
        duration: distance / 800 + 2, // Flight time + airport
        cost: estimateFlightCost(distance),
        emissions: distance * 0.25,
      };
    case 'train':
      return {
        distance,
        duration: distance / 120,
        cost: estimateTrainCost(distance),
        emissions: distance * 0.04,
      };
  }
}
```

**Features:**
- [ ] Auto-calculate distance between consecutive shows
- [ ] Estimate travel costs (car, flight, train, bus)
- [ ] CO2 emissions tracking
- [ ] Route optimization: "Best order to minimize travel"
- [ ] Integration with finance module (auto-add travel expenses)

**UI Enhancements:**
- [ ] Venue map in Shows page
- [ ] "Add Venue" ‚Üí Search Google Places
- [ ] Travel costs in show details
- [ ] Tour route visualization on map

**Success Criteria:**
- ‚úÖ Venue search returns accurate results
- ‚úÖ Auto-fill saves 50% time vs manual entry
- ‚úÖ Travel cost estimates within 20% of actual
- ‚úÖ Users report improved tour planning efficiency

---

### 3.2 Advanced Template System (Week 7-9)

**Current State:**
- Create shows one by one
- No templates for recurring tours
- Manual entry for similar shows

**Template System:**

```typescript
// src/types/template.ts
export interface ShowTemplate {
  id: string;
  name: string;
  description: string;
  organizationId: string;
  fields: {
    venue?: VenueTemplate;
    fee?: number | 'variable';
    capacity?: number;
    promoter?: string;
    technicalRequirements?: string[];
    riders?: {
      hospitality: string;
      technical: string;
      backline: string;
    };
  };
  createdAt: Date;
  createdBy: string;
  usageCount: number;
}

// src/types/tour.ts
export interface TourTemplate {
  id: string;
  name: string; // "European Summer Tour 2026"
  shows: ShowTemplate[];
  totalDuration: number; // days
  estimatedRevenue: number;
  estimatedCosts: number;
}
```

**Features:**

#### 3.2.1 Show Templates

```tsx
// src/components/templates/ShowTemplateSelector.tsx
export function ShowTemplateSelector({ onSelect }) {
  const templates = [
    {
      name: 'Festival Slot',
      fields: { duration: 60, setupTime: 30, soundcheck: true }
    },
    {
      name: 'Club Show',
      fields: { duration: 90, setupTime: 60, merchandise: true }
    },
    {
      name: 'Arena Concert',
      fields: { duration: 120, setupTime: 240, crew: 'full' }
    }
  ];
  
  return (
    <TemplateGrid>
      {templates.map(t => (
        <TemplateCard onClick={() => onSelect(t)}>
          <h3>{t.name}</h3>
          <p>Pre-fill: {Object.keys(t.fields).join(', ')}</p>
        </TemplateCard>
      ))}
    </TemplateGrid>
  );
}
```

**Implementation:**
- [ ] Create Template management UI
- [ ] Save frequently used show configurations
- [ ] Quick create from template (1 click)
- [ ] Template marketplace (share with other orgs - v2.3)
- [ ] Customizable fields per template

#### 3.2.2 Tour Templates

```tsx
// src/pages/dashboard/TourPlanner.tsx
export function TourPlanner() {
  const [template, setTemplate] = useState<TourTemplate>();
  
  // 1. Select tour template (or create new)
  // 2. Add venues/dates
  // 3. System suggests optimal routing
  // 4. Auto-calculate total costs
  // 5. Generate all shows at once
  
  return (
    <TourPlannerLayout>
      <TourTimeline shows={template.shows} />
      <TourMap route={optimizedRoute} />
      <TourFinancials revenue={estimated} costs={estimated} />
      <Button onClick={generateTour}>
        Generate {template.shows.length} Shows
      </Button>
    </TourPlannerLayout>
  );
}
```

**Features:**
- [ ] Multi-show creation (tour planner)
- [ ] Drag-and-drop tour dates
- [ ] Auto-suggest venues based on capacity/location
- [ ] Clone past tours (repeat annual tours)
- [ ] Share tour templates with team

**Use Cases:**
- **Scenario 1:** Artist has annual European tour ‚Üí Save as template, reuse next year
- **Scenario 2:** Festival circuit ‚Üí Template with 15 festivals, auto-fill standard fees
- **Scenario 3:** Venue residency ‚Üí Template for weekly shows at same venue

**Success Criteria:**
- ‚úÖ 50% reduction in time to create tour (vs one-by-one)
- ‚úÖ 80%+ of tours use templates (adoption)
- ‚úÖ Templates reduce data entry errors by 40%

---

### 3.3 Quick Access & Smart Shortcuts (Week 8-10)

**Current State:**
- Navigate through menus to access features
- No quick actions for common tasks
- Limited keyboard shortcuts

**Enhanced UX:**

#### 3.3.1 Command Palette Enhancement

```tsx
// src/components/CommandPalette.tsx - Enhanced
export function CommandPalette() {
  const commands = [
    // Existing
    { id: 'new-show', label: 'Create Show', icon: Plus },
    
    // NEW: Quick access
    { id: 'venue-contracts', label: 'View Venue Contracts', icon: FileText },
    { id: 'upcoming-advance', label: 'Shows Needing Advance', icon: Clock },
    { id: 'pending-payments', label: 'Pending Payments', icon: DollarSign },
    { id: 'export-tour', label: 'Export Current Tour', icon: Download },
    
    // NEW: Smart actions
    { id: 'duplicate-show', label: 'Duplicate Selected Show', icon: Copy },
    { id: 'send-advance', label: 'Send Advance to Venue', icon: Send },
    { id: 'mark-paid', label: 'Mark Show as Paid', icon: Check },
  ];
  
  // Search commands, recent actions, smart suggestions
}
```

**Features:**
- [ ] Quick access to contracts by venue
- [ ] "Shows needing advance" filter
- [ ] "Pending payments" shortcut
- [ ] Smart suggestions based on context
- [ ] Recent actions history

#### 3.3.2 Advance Templates & Quick Send

```typescript
// src/services/AdvanceService.ts
export class AdvanceService {
  static templates = {
    standard: {
      title: 'Show Advance - {showName}',
      sections: ['Schedule', 'Technical', 'Hospitality', 'Contacts'],
      autoInclude: ['stage_plot', 'input_list', 'rider'],
    },
    festival: {
      title: 'Festival Slot - {artistName}',
      sections: ['Set Times', 'Technical', 'Backstage', 'Guest List'],
      autoInclude: ['stage_plot', 'set_list'],
    }
  };
  
  static async generateAdvance(show: Show, template: string) {
    const advance = this.templates[template];
    
    // Auto-fill from show data
    return {
      ...advance,
      showName: show.venueName,
      date: show.date,
      venue: show.venue,
      contacts: show.promoter,
      // Attach contracts, riders, tech specs
    };
  }
  
  static async sendAdvance(showId: string, recipients: string[]) {
    // Generate PDF, email to venue/promoter
  }
}
```

**Implementation:**
- [ ] Advance template system
- [ ] One-click "Send Advance" from show details
- [ ] Auto-attach contracts and riders
- [ ] Track advance sent status
- [ ] Reminder: "Advance due in 3 days"

**Success Criteria:**
- ‚úÖ 70% reduction in time to send advance
- ‚úÖ Venue contracts accessible in 2 clicks
- ‚úÖ Users report "much easier" to manage advances

---

## üåç Priority 4: Internationalization & UX

### 4.1 Complete i18n Expansion (Week 8-10)

**Current Status:**
```
EN: 100% (1227/1227 keys)
ES: 100% (1227/1227 keys)
FR: 43% (528/1227 keys) ‚ùå
DE: 39% (478/1227 keys) ‚ùå
IT: 35% (429/1227 keys) ‚ùå
PT: 37% (454/1227 keys) ‚ùå
```

**Target:** 100% for all 6 languages

**Strategy:**

#### 4.1.1 Auto-Translation Workflow

```bash
# scripts/translate-batch.mjs
import OpenAI from 'openai';

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

async function translateKeys(keys, targetLang) {
  const prompt = `
You are a professional translator specializing in music industry terminology.
Translate these UI keys from English to ${targetLang}.
Preserve placeholders like {name}, {count}.
Maintain professional, concise tone.

Keys to translate:
${JSON.stringify(keys, null, 2)}

Return ONLY valid JSON with translations.
  `;
  
  const response = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [{ role: 'user', content: prompt }],
    temperature: 0.3, // Low temperature for consistency
  });
  
  return JSON.parse(response.choices[0].message.content);
}
```

**Process:**
1. **Week 8:** Auto-translate remaining 699 keys (FR)
2. **Week 9:** Auto-translate DE (749 keys), IT (798 keys), PT (773 keys)
3. **Week 10:** Native speaker review and corrections

#### 4.1.2 Music Industry Terminology Validation

**Critical terms to validate with native speakers:**
```typescript
const musicTerms = {
  // Technical
  'rider': {
    FR: 'fiche technique', // Not 'cavalier'
    DE: 'Rider', // Often kept in English
    IT: 'rider tecnico',
    PT: 'rider t√©cnico',
  },
  'advance': {
    FR: 'fiche d\'avance', // Or 'avance'
    DE: 'Advance',
    IT: 'scheda tecnica',
    PT: 'ficha t√©cnica',
  },
  'backline': {
    FR: 'backline', // Often kept
    DE: 'Backline',
    IT: 'backline',
    PT: 'backline',
  },
  // Contracts
  'promoter': {
    FR: 'promoteur',
    DE: 'Veranstalter',
    IT: 'promoter',
    PT: 'promotor',
  },
  'guarantee': {
    FR: 'cachet garanti',
    DE: 'Garantie',
    IT: 'garanzia',
    PT: 'garantia',
  },
};
```

**Validation:**
- [ ] Hire native speakers for FR, DE, IT, PT (Upwork/Fiverr)
- [ ] Review 50 most used music terms
- [ ] Test with beta users in each language
- [ ] Iterate based on feedback

#### 4.1.3 Language Switcher UX

```tsx
// src/components/LanguageSwitcher.tsx - Enhanced
export function LanguageSwitcher() {
  const { lang, setLang } = useSettings();
  
  const languages = [
    { code: 'en', name: 'English', flag: 'üá¨üáß', complete: 100 },
    { code: 'es', name: 'Espa√±ol', flag: 'üá™üá∏', complete: 100 },
    { code: 'fr', name: 'Fran√ßais', flag: 'üá´üá∑', complete: 43 }, // Show %
    { code: 'de', name: 'Deutsch', flag: 'üá©üá™', complete: 39 },
    { code: 'it', name: 'Italiano', flag: 'üáÆüáπ', complete: 35 },
    { code: 'pt', name: 'Portugu√™s', flag: 'üáµüáπ', complete: 37 },
  ];
  
  return (
    <Select value={lang} onChange={setLang}>
      {languages.map(l => (
        <Option value={l.code}>
          {l.flag} {l.name} {l.complete < 100 && `(${l.complete}%)`}
        </Option>
      ))}
    </Select>
  );
}
```

**Success Criteria:**
- ‚úÖ All 6 languages at 100% (1227/1227 keys)
- ‚úÖ Music terminology validated by native speakers
- ‚úÖ Beta users report "natural" translations
- ‚úÖ Zero untranslated keys in production

---

### 4.2 Mobile PWA Enhancements (Week 9-11)

**Current State:**
- PWA installable
- Offline mode works
- Basic haptic feedback

**Enhanced Mobile Experience:**

#### 4.2.1 Haptic Feedback Expansion

```typescript
// src/lib/haptics.ts - Enhanced
export const haptics = {
  // Existing
  light: () => navigator.vibrate?.(10),
  medium: () => navigator.vibrate?.(20),
  heavy: () => navigator.vibrate?.(30),
  
  // NEW: Contextual haptics
  success: () => navigator.vibrate?.([10, 50, 10]), // Double tap
  error: () => navigator.vibrate?.([50, 100, 50, 100, 50]), // Alert pattern
  notification: () => navigator.vibrate?.(15),
  
  // NEW: Interactive haptics
  buttonPress: () => navigator.vibrate?.(5),
  swipeAction: () => navigator.vibrate?.(8),
  longPress: () => navigator.vibrate?.([10, 20, 10]),
};

// Auto-trigger on actions
export function useHaptic() {
  const onClick = (callback: () => void) => {
    haptics.buttonPress();
    callback();
  };
  
  const onSuccess = (callback: () => void) => {
    haptics.success();
    callback();
  };
  
  const onError = (callback: () => void) => {
    haptics.error();
    callback();
  };
  
  return { onClick, onSuccess, onError };
}
```

**Implementation:**
- [ ] Haptic on all button clicks
- [ ] Haptic on swipe actions (delete, archive)
- [ ] Haptic on notifications (new invite, etc.)
- [ ] Haptic on success/error toasts
- [ ] Settings: Enable/disable haptics

#### 4.2.2 Push Notifications

```typescript
// src/services/NotificationService.ts
export class NotificationService {
  static async requestPermission() {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      await this.subscribeToNotifications();
    }
  }
  
  static async subscribeToNotifications() {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: VAPID_PUBLIC_KEY,
    });
    
    // Save to Firestore
    await saveSubscription(subscription);
  }
  
  static triggers = {
    showReminder: '24 hours before show',
    paymentDue: 'Payment due in 3 days',
    teamInvite: 'New team member joined',
    contractExpiring: 'Contract expires in 7 days',
    advanceNeeded: 'Advance due for {venue}',
  };
}
```

**Notifications:**
- [ ] Show reminders (24h, 1 week before)
- [ ] Payment due alerts
- [ ] Team activity (new member, role change)
- [ ] Contract expiration warnings
- [ ] Custom reminders (user-defined)

#### 4.2.3 Offline Improvements

```typescript
// src/lib/offline/cache-strategy.ts
export const cacheStrategy = {
  // Critical: Always cache, update in background
  critical: ['shows', 'contacts', 'user-profile'],
  
  // Important: Cache, refresh on online
  important: ['finance', 'contracts', 'timeline'],
  
  // Optional: Cache on demand, expire after 1 day
  optional: ['venue-photos', 'maps', 'reports'],
};

// Pre-cache critical data on login
export async function preCacheUserData(userId: string) {
  const shows = await getShows(userId);
  const contacts = await getContacts(userId);
  const profile = await getUserProfile(userId);
  
  await Promise.all([
    cacheShows(shows),
    cacheContacts(contacts),
    cacheProfile(profile),
  ]);
  
  console.log('‚úÖ Critical data cached for offline use');
}
```

**Improvements:**
- [ ] Pre-cache on login (faster offline access)
- [ ] Background sync for photos/files
- [ ] Offline indicator with sync status
- [ ] Manual "Download for Offline" button
- [ ] Clear cache option in settings

**Success Criteria:**
- ‚úÖ Haptic feedback on all interactions
- ‚úÖ Push notifications 90%+ delivery rate
- ‚úÖ Offline mode works for 7 days without sync
- ‚úÖ Users report "feels like native app"

---

### 4.3 Cloudflare CDN Integration (Week 10-12)

**Current State:**
- Hosted on Vercel
- No CDN
- DNS managed separately

**Cloudflare Integration:**

#### 4.3.1 Setup

```bash
# 1. Add domain to Cloudflare
# 2. Update DNS records
# 3. Enable CDN (orange cloud)
# 4. Configure caching rules

# Cloudflare Workers for API caching
export default {
  async fetch(request) {
    const cache = caches.default;
    let response = await cache.match(request);
    
    if (!response) {
      response = await fetch(request);
      
      // Cache for 1 hour
      const headers = new Headers(response.headers);
      headers.set('Cache-Control', 'public, max-age=3600');
      
      response = new Response(response.body, {
        status: response.status,
        headers,
      });
      
      await cache.put(request, response.clone());
    }
    
    return response;
  }
};
```

**Features:**
- [ ] Global CDN (200+ locations)
- [ ] Auto-minify JS/CSS/HTML
- [ ] Brotli compression
- [ ] Image optimization (WebP, AVIF)
- [ ] DDoS protection
- [ ] Web Application Firewall (WAF)

#### 4.3.2 Performance Gains

**Expected improvements:**
```
Before Cloudflare:
- Load time (EU): 1.8s
- Load time (US): 2.5s
- Load time (Asia): 3.8s

After Cloudflare:
- Load time (EU): 1.2s (-33%)
- Load time (US): 1.4s (-44%)
- Load time (Asia): 1.9s (-50%)
```

**Security:**
- [ ] HTTPS enforcement (always)
- [ ] HSTS headers
- [ ] Rate limiting (100 req/min per IP)
- [ ] Bot protection
- [ ] Email obfuscation

**Success Criteria:**
- ‚úÖ Load time reduction: 30%+ globally
- ‚úÖ DDoS protection active
- ‚úÖ 99.99% uptime (Cloudflare SLA)
- ‚úÖ Bandwidth savings: 40%+ (compression + caching)

---

## üìÖ Timeline & Milestones

### Month 1 (Weeks 1-4): Security & Foundation
```
Week 1:
- [ ] Remove xlsx vulnerability (exceljs migration)
- [ ] Start audit logging implementation
- [ ] Begin MFA enhancements

Week 2:
- [ ] Complete audit logging
- [ ] MFA WebAuthn integration
- [ ] Start multi-tenancy tests

Week 3:
- [ ] MFA policy enforcement
- [ ] Multi-tenancy isolation tests
- [ ] Start offline conflict resolution

Week 4:
- [ ] Complete MFA feature
- [ ] Offline sync tests
- [ ] Start bundle optimization
```

### Month 2 (Weeks 5-8): Performance & Features
```
Week 5:
- [ ] Bundle size optimization
- [ ] Code splitting implementation
- [ ] Start venue management enhancement

Week 6:
- [ ] Complete offline conflict resolution
- [ ] Integration tests (80%+ coverage)
- [ ] Venue map implementation

Week 7:
- [ ] Mobile PWA optimizations
- [ ] Venue scouting (Google Places)
- [ ] Start template system

Week 8:
- [ ] E2E tests (critical flows)
- [ ] Travel cost calculator
- [ ] Complete venue enhancements
- [ ] Start i18n translation
```

### Month 3 (Weeks 9-12): UX & Polish
```
Week 9:
- [ ] Complete template system
- [ ] Continue i18n (FR/DE complete)
- [ ] Start push notifications

Week 10:
- [ ] Complete i18n (IT/PT complete)
- [ ] Quick access shortcuts
- [ ] Advance template system
- [ ] Start Cloudflare setup

Week 11:
- [ ] Native speaker review (i18n)
- [ ] Haptic feedback expansion
- [ ] Cloudflare CDN live

Week 12:
- [ ] Final testing & QA
- [ ] Performance audit
- [ ] Beta user feedback
- [ ] Release preparation
```

---

## üß™ Testing Strategy

### Test Coverage Goals

**Current:** 73.5%  
**Target:** 85%+

**Breakdown:**
```
Unit Tests: 60% ‚Üí 75% (+15%)
Integration Tests: 15% ‚Üí 20% (+5%)
E2E Tests: 5% ‚Üí 10% (+5%)
```

### Critical Test Scenarios

#### 1. Multi-Tenancy
```typescript
describe('Multi-Tenancy Security', () => {
  test('User cannot see other org data', async () => {
    // Create 2 orgs with shows
    // User in org A
    // Expect: Only org A shows visible
  });
  
  test('User cannot modify other org data', async () => {
    // Attempt to edit org B show
    // Expect: Permission denied
  });
  
  test('Org switching clears sensitive data', async () => {
    // Switch from org A to org B
    // Expect: No org A data in memory/cache
  });
});
```

#### 2. Offline Sync
```typescript
describe('Offline Conflict Resolution', () => {
  test('Auto-merge non-conflicting changes', async () => {
    // User A offline: change city
    // User B online: change fee
    // User A goes online
    // Expect: Both changes merged
  });
  
  test('Detect conflicting changes', async () => {
    // Both change same field
    // Expect: Conflict dialog shown
  });
  
  test('Preserve data on network failure', async () => {
    // Create show offline
    // Network fails during sync
    // Expect: Show saved locally, retry on reconnect
  });
});
```

#### 3. Performance
```typescript
describe('Performance Benchmarks', () => {
  test('Large dataset rendering', async () => {
    // Load 1000 shows
    // Expect: < 2s to render (virtualized)
  });
  
  test('Offline mode activation', async () => {
    // Go offline
    // Expect: < 500ms to show offline indicator
  });
  
  test('Bundle size under limit', () => {
    const stats = fs.readFileSync('dist/stats.json');
    const totalSize = calculateGzippedSize(stats);
    expect(totalSize).toBeLessThan(700 * 1024); // 700KB
  });
});
```

---

## üöÄ Release Criteria

### Must-Have (Blocking)
- [ ] ‚úÖ Zero High/Critical npm vulnerabilities
- [ ] ‚úÖ Test coverage ‚â• 85%
- [ ] ‚úÖ All 6 languages at 100% translation
- [ ] ‚úÖ MFA enforced for Owner/Admin roles
- [ ] ‚úÖ Offline conflict resolution working
- [ ] ‚úÖ Performance: Lighthouse score ‚â• 90

### Should-Have (High Priority)
- [ ] ‚úÖ Bundle size < 700KB
- [ ] ‚úÖ Venue map and auto-fill working
- [ ] ‚úÖ Template system implemented
- [ ] ‚úÖ Push notifications working
- [ ] ‚úÖ Cloudflare CDN live

### Nice-to-Have (Can Delay)
- [ ] Haptic feedback on all actions
- [ ] Advanced shortcuts and quick actions
- [ ] Travel cost calculator
- [ ] Advance template system

---

## üìä Success Metrics

### Technical Metrics
```
Test Coverage: 73.5% ‚Üí 85%+ ‚úÖ
Bundle Size: 845KB ‚Üí <700KB ‚úÖ
Load Time: 1.8s ‚Üí <1.5s ‚úÖ
Lighthouse Score: 85 ‚Üí 90+ ‚úÖ
npm Audit: 1 High ‚Üí 0 High/Critical ‚úÖ
```

### User Metrics
```
i18n Completeness: EN/ES 100%, Others 35-43% ‚Üí All 100% ‚úÖ
MFA Adoption: 0% ‚Üí 90%+ (Owner/Admin) ‚úÖ
Offline Usage: 20% ‚Üí 60%+ of users ‚úÖ
Time to Create Tour: 30 min ‚Üí 10 min (template) ‚úÖ
User Satisfaction: Baseline ‚Üí +25% NPS ‚úÖ
```

### Business Metrics
```
Beta Users: 25 ‚Üí 100+ orgs ‚úÖ
Shows Managed: 2,500+ ‚Üí 10,000+ ‚úÖ
Uptime: 99.5% ‚Üí 99.99% (Cloudflare) ‚úÖ
Support Tickets: Baseline ‚Üí -30% (better UX) ‚úÖ
```

---

## üîÑ Migration from v2.1 to v2.2

### Breaking Changes

#### 1. Export API Changes
```typescript
// v2.1 (OLD)
import { exportToExcel } from '@/lib/exportToExcel';
exportToExcel(data, 'filename'); // Uses xlsx

// v2.2 (NEW)
import { exportToExcel, exportToCSV } from '@/lib/exportToExcel';
exportToExcel(data, 'filename'); // Uses exceljs
exportToCSV(data, 'filename'); // NEW: Faster, lighter
```

**Migration:**
- No user action required
- Exports work identically
- CSV option now available (recommended for large datasets)

#### 2. MFA Enforcement
```typescript
// v2.1: MFA optional for all
// v2.2: MFA required for Owner/Admin after 7-day grace period

// Organizations can configure policy
{
  mfaRequired: true,
  requiredForRoles: ['owner', 'admin'],
  gracePeriodDays: 7
}
```

**Migration:**
- Owners/Admins notified 7 days before enforcement
- Email: "Enable MFA in 3 days"
- After grace period: Forced MFA setup on login

#### 3. Offline Data Structure
```typescript
// v2.1: Simple conflict detection
// v2.2: Field-level change tracking

// OLD
{ id, data, lastModified }

// NEW
{
  id,
  data,
  lastModified,
  changes: [
    { field: 'fee', oldValue: 2000, newValue: 2500, userId: '...' }
  ]
}
```

**Migration:**
- Auto-migration on first sync after v2.2 update
- No data loss
- Better conflict resolution

### Database Changes

#### New Firestore Collections
```typescript
// audit_logs (NEW)
{
  id: string;
  organizationId: string;
  userId: string;
  action: 'create' | 'update' | 'delete';
  collection: 'shows' | 'contacts' | 'finance' | ...;
  documentId: string;
  changes: { field: string; oldValue: any; newValue: any }[];
  ipAddress: string;
  userAgent: string;
  timestamp: Timestamp;
}

// show_templates (NEW)
{
  id: string;
  organizationId: string;
  name: string;
  description: string;
  fields: Record<string, any>;
  usageCount: number;
  createdBy: string;
  createdAt: Timestamp;
}

// tour_templates (NEW)
{
  id: string;
  organizationId: string;
  name: string;
  shows: ShowTemplate[];
  estimatedRevenue: number;
  estimatedCosts: number;
  createdBy: string;
  createdAt: Timestamp;
}
```

**Migration Script:**
```bash
# Run after v2.2 deployment
npm run migrate:v2.2

# Creates new collections
# Indexes audit_logs by organizationId + timestamp
# Backfills existing data (optional)
```

---

## üéì Documentation Updates

### New Docs to Create
- [ ] `VENUE_MANAGEMENT.md` - Venue scouting, maps, travel costs
- [ ] `TEMPLATE_SYSTEM.md` - Show and tour templates
- [ ] `OFFLINE_SYNC.md` - Conflict resolution guide
- [ ] `MFA_SETUP.md` - User guide for MFA setup
- [ ] `AUDIT_LOGGING.md` - How to use audit logs

### Docs to Update
- [ ] `SECURITY.md` - Remove xlsx vulnerability, add MFA enforcement
- [ ] `PERFORMANCE_GUIDE.md` - New bundle size, load time metrics
- [ ] `USER_GUIDE.md` - Add sections for templates, venues, MFA
- [ ] `CHANGELOG.md` - v2.2 full changelog
- [ ] `README.md` - Update metrics, status badges

---

## üë• Team & Resources

### Development Team
```
Lead Developer: Sergi Recio
Frontend: 1-2 developers (contract)
Backend: 1 developer (Firebase, API)
QA/Testing: 1 tester + automated tests
DevOps: 1 engineer (Cloudflare, monitoring)
```

### External Resources
```
i18n Translators: 4 native speakers (FR, DE, IT, PT)
Security Auditor: External audit after v2.2
Beta Testers: 50-100 users
UX Feedback: 10-20 power users
```

### Budget Estimate
```
Development (3 months): ‚Ç¨30,000 - ‚Ç¨50,000
External Services:
  - Google Places API: ‚Ç¨200/month
  - Cloudflare Pro: ‚Ç¨20/month
  - Sentry Business: ‚Ç¨50/month
  - Translation: ‚Ç¨2,000 (one-time)
  - Security Audit: ‚Ç¨3,000 (one-time)

Total: ‚Ç¨35,000 - ‚Ç¨55,000
```

---

## üéâ Post-Release (v2.2+)

### v2.3 Preview (Q2 2026)
- OAuth login (Google, Microsoft, Apple)
- API for third-party integrations
- Webhooks (Zapier, Make.com)
- Mobile app (React Native or Capacitor)
- Advanced analytics dashboard
- Template marketplace (share templates)

### v3.0 Vision (Q3 2026)
- AI-powered tour planning
- Automated contract generation
- Financial forecasting & budgeting
- Social media integration
- Fan engagement tools
- White-label solution for agencies

---

## üìû Feedback & Iteration

### Beta User Feedback Loop
```
Week 2: First beta release (security features)
Week 4: Survey #1 (MFA, audit logs)
Week 6: Second beta (performance, venues)
Week 8: Survey #2 (templates, offline)
Week 10: Third beta (i18n, mobile)
Week 12: Final survey before release
```

### Metrics Dashboard
```
Track weekly:
- Active users
- Features adopted
- Bug reports
- Performance metrics
- User satisfaction (NPS)

Adjust roadmap based on data
```

---

## ‚úÖ Acceptance Criteria

### v2.2 is ready when:
- [ ] All Priority 1 tasks complete (Security)
- [ ] All Priority 2 tasks complete (Performance & Testing)
- [ ] 80%+ of Priority 3 tasks complete (Features)
- [ ] 70%+ of Priority 4 tasks complete (UX)
- [ ] All "Must-Have" release criteria met
- [ ] Beta users report satisfaction ‚â• 8/10
- [ ] Zero blocking bugs
- [ ] Documentation complete
- [ ] Security audit passed

---

**Ready to start v2.2 development! üöÄ**

*Last updated: November 15, 2025*
